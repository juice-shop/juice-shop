name: "Deployment to AWS"

# Kien's workflow - Continuous Delivery to AWS
# This workflow is called by security-enhanced.yml OR can run independently

on:
  workflow_call: # Called by main pipeline
    inputs:
      environment:
        description: "Deployment environment (staging or production)"
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: false
      EC2_HOST:
        required: false
      EC2_SSH_KEY:
        required: false
      EB_APPLICATION_NAME:
        required: false
      S3_BUCKET:
        required: false
      APP_RUNNER_ARN:
        required: false
      ECR_REGISTRY:
        required: false
      PROD_URL:
        required: false
      STAGING_URL:
        required: false

  workflow_dispatch: # Can be triggered manually
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - feature/kien

env:
  NODE_VERSION: 22

jobs:
  deploy-to-aws:
    name: "Deploy to AWS ${{ inputs.environment || 'staging' }}"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'staging' }}
      url: ${{ inputs.environment == 'production' && 'https://prod.your-team.juice-shop.com' || 'https://staging.your-team.juice-shop.com' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      # Option 1: Deploy to EC2 via SSH
      - name: Deploy to EC2 (if using EC2)
        if: secrets.EC2_HOST != ''
        run: |
          echo "ðŸš€ Deploying to AWS EC2"
          echo "Environment: ${{ inputs.environment || 'staging' }}"

          # Install SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cd /app/juice-shop
            git pull origin ${{ github.ref_name }}
            npm install --production
            npm run build:server
            pm2 restart juice-shop || pm2 start build/app.js --name juice-shop
          EOF

          echo "âœ… Deployment to EC2 completed"

      # Option 2: Deploy to Elastic Beanstalk
      - name: Deploy to Elastic Beanstalk (if using EB)
        if: secrets.EB_APPLICATION_NAME != ''
        run: |
          echo "ðŸš€ Deploying to AWS Elastic Beanstalk"

          # Create deployment package
          zip -r deploy.zip . -x "*.git*" "node_modules/*" "frontend/node_modules/*"

          # Deploy to EB
          aws elasticbeanstalk create-application-version \
            --application-name ${{ secrets.EB_APPLICATION_NAME }} \
            --version-label ${{ github.sha }} \
            --source-bundle S3Bucket=${{ secrets.S3_BUCKET }},S3Key=deploy.zip

          aws elasticbeanstalk update-environment \
            --application-name ${{ secrets.EB_APPLICATION_NAME }} \
            --environment-name ${{ inputs.environment || 'staging' }} \
            --version-label ${{ github.sha }}

          echo "âœ… Deployment to Elastic Beanstalk initiated"

      # Option 3: Deploy to App Runner (simplest)
      - name: Deploy to App Runner (if using App Runner)
        if: secrets.APP_RUNNER_ARN != ''
        run: |
          echo "ðŸš€ Deploying to AWS App Runner"

          # App Runner deploys from container registry
          # Build and push container
          docker build -t juice-shop:${{ github.sha }} .

          # Tag and push to ECR
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          docker tag juice-shop:${{ github.sha }} ${{ secrets.ECR_REGISTRY }}/juice-shop:latest
          docker push ${{ secrets.ECR_REGISTRY }}/juice-shop:latest

          echo "âœ… Container pushed to ECR - App Runner will auto-deploy"

      - name: Health check
        run: |
          echo "ðŸ¥ Performing health check..."
          sleep 10

          # Check if deployment is healthy
          DEPLOY_URL="${{ inputs.environment == 'production' && secrets.PROD_URL || secrets.STAGING_URL }}"

          if [ ! -z "$DEPLOY_URL" ]; then
            curl -f $DEPLOY_URL/rest/admin/application-version || echo "âš ï¸ Health check needs configuration"
          fi

          echo "âœ… Deployment health check completed"

      - name: Post deployment summary
        run: |
          echo "ðŸ“Š Deployment Summary"
          echo "Environment: ${{ inputs.environment || 'staging' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployed by: ${{ github.actor }}"
